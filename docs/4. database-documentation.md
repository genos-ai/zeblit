# AI Development Platform - Database Schema Documentation

## Overview

The database schema is designed to support a multi-tenant AI development platform with the following key features:
- User management with role-based access control
- Project and file management
- AI agent coordination and conversation tracking
- Cost tracking for LLM usage
- Container lifecycle management
- Git integration for version control
- Comprehensive audit logging

## Database Technology

- **Database**: PostgreSQL 16+
- **ORM**: SQLAlchemy 2.0
- **Migration Tool**: Alembic
- **Connection Pooling**: NullPool (for async compatibility)

## Core Tables

### 1. **users**
Stores user accounts and authentication information.

**Key Fields:**
- `id` (UUID): Primary key
- `email` (String): Unique email address
- `username` (String): Unique username
- `role` (Enum): user, admin, superuser
- `hashed_password` (String): Bcrypt hashed password
- `monthly_token_limit` (Integer): Token usage limit
- `monthly_cost_limit` (Float): Cost limit in USD

**Relationships:**
- One-to-Many: projects, tasks, conversations, cost_records

### 2. **projects**
Represents user projects/applications.

**Key Fields:**
- `id` (UUID): Primary key
- `name` (String): Project name
- `owner_id` (UUID): Foreign key to users
- `template_type` (String): Project template used
- `status` (Enum): active, archived, deleted
- `container_id` (String): Associated container ID
- `git_repo_url` (String): Git repository URL

**Relationships:**
- Many-to-One: owner (User)
- Many-to-Many: collaborators (Users)
- One-to-Many: tasks, files, conversations, containers

### 3. **tasks**
Tracks AI agent tasks and their execution.

**Key Fields:**
- `id` (UUID): Primary key
- `project_id` (UUID): Foreign key to projects
- `title` (String): Task title
- `description` (Text): Detailed description
- `status` (Enum): pending, assigned, in_progress, completed, failed
- `assigned_agents` (Array): List of assigned agent types
- `results` (JSONB): Task execution results
- `execution_time_seconds` (Integer): Time taken

**Relationships:**
- Many-to-One: project, user
- One-to-Many: subtasks, agent_messages

### 4. **agents**
Defines the AI agents and their configurations.

**Key Fields:**
- `id` (UUID): Primary key
- `agent_type` (Enum): dev_manager, product_manager, etc.
- `name` (String): Display name
- `system_prompt` (Text): Agent's system prompt
- `default_model` (String): Default LLM model
- `current_load` (Integer): Active task count

**Pre-seeded Agents:**
1. Development Manager
2. Product Manager
3. Data Analyst
4. Senior Engineer
5. Architect
6. Platform Engineer

### 5. **conversations**
Manages chat conversations between users and agents.

**Key Fields:**
- `id` (UUID): Primary key
- `project_id` (UUID): Foreign key to projects
- `user_id` (UUID): Foreign key to users
- `agent_id` (UUID): Foreign key to agents
- `context` (JSONB): Conversation context
- `is_active` (Boolean): Active status

**Relationships:**
- Many-to-One: project, user, agent
- One-to-Many: messages

### 6. **agent_messages**
Stores individual messages in conversations.

**Key Fields:**
- `id` (UUID): Primary key
- `conversation_id` (UUID): Foreign key to conversations
- `role` (String): user, assistant, system
- `content` (Text): Message content
- `token_count` (Integer): Tokens used
- `model_used` (String): LLM model used

### 7. **cost_tracking**
Tracks LLM API usage and costs.

**Key Fields:**
- `id` (UUID): Primary key
- `user_id` (UUID): Foreign key to users
- `provider` (String): anthropic, openai, google
- `model` (String): Specific model used
- `input_tokens` (Integer): Input token count
- `output_tokens` (Integer): Output token count
- `total_cost` (Float): Cost in USD

### 8. **containers**
Manages user development containers.

**Key Fields:**
- `id` (UUID): Primary key
- `project_id` (UUID): Foreign key to projects
- `container_id` (String): Docker/OrbStack container ID
- `status` (Enum): creating, running, sleeping, stopped
- `cpu_limit` (Float): CPU cores allocated
- `memory_limit` (Integer): Memory in MB
- `preview_url` (String): Application preview URL

### 9. **project_files**
Tracks files in projects.

**Key Fields:**
- `id` (UUID): Primary key
- `project_id` (UUID): Foreign key to projects
- `file_path` (String): Relative file path
- `file_type` (String): File extension/type
- `created_by_agent` (String): Which agent created it

### 10. **git_branches**
Manages Git branches created by agents.

**Key Fields:**
- `id` (UUID): Primary key
- `project_id` (UUID): Foreign key to projects
- `branch_name` (String): Git branch name
- `created_by_agent` (String): Agent that created it
- `is_merged` (Boolean): Merge status

### 11. **project_templates**
Pre-defined project templates.

**Pre-seeded Templates:**
1. react-typescript
2. nextjs-typescript
3. python-fastapi
4. fullstack-react-fastapi

### 12. **audit_logs**
Comprehensive audit trail for compliance.

**Key Fields:**
- `id` (UUID): Primary key
- `user_id` (UUID): Foreign key to users
- `action` (String): Action performed
- `resource_type` (String): Type of resource
- `details` (JSONB): Additional context

## Database Setup

### 1. Initial Setup
```bash
# Set environment variable
export DATABASE_URL="postgresql://user:password@localhost/ai_dev_platform"

# Run initialization script
python backend/scripts/init_db.py
```

### 2. Manual Migration
```bash
# Create new migration
alembic revision -m "Add new feature"

# Run migrations
alembic upgrade head

# Rollback one version
alembic downgrade -1
```

### 3. Reset Database (Development Only)
```bash
python backend/scripts/reset_db.py
```

## Usage Examples

### Creating a User
```python
from repositories.user_repository import UserRepository
from db.session import get_db

with get_db() as db:
    user_repo = UserRepository(db)
    user = user_repo.create_user(
        email="developer@example.com",
        username="developer",
        password="secure_password",
        full_name="John Developer"
    )
```

### Creating a Project
```python
from repositories.project_repository import ProjectRepository

with get_db() as db:
    project_repo = ProjectRepository(db)
    project = project_repo.create(
        name="My React App",
        description="A new React application",
        owner_id=user.id,
        template_type="react-typescript"
    )
```

### Tracking LLM Usage
```python
from models.database import CostTracking

cost_record = CostTracking(
    user_id=user.id,
    project_id=project.id,
    provider="anthropic",
    model="claude-3-5-sonnet",
    input_tokens=1500,
    output_tokens=500,
    input_cost=0.0045,  # $0.003 per 1K tokens
    output_cost=0.0075,  # $0.015 per 1K tokens
    total_cost=0.012,
    agent_type="engineer"
)
db.add(cost_record)
db.commit()
```

### Querying with Relationships
```python
# Get project with all details
project = db.query(Project).options(
    joinedload(Project.files),
    joinedload(Project.conversations),
    joinedload(Project.containers)
).filter(Project.id == project_id).first()

# Get user's active projects
active_projects = db.query(Project).filter(
    Project.owner_id == user_id,
    Project.status == ProjectStatus.ACTIVE
).order_by(Project.last_accessed.desc()).all()
```

## Indexes and Performance

### Key Indexes
- `users`: email + is_active (composite)
- `projects`: owner_id + status, container_id
- `tasks`: project_id + status, assigned_agents (GIN)
- `conversations`: project_id + user_id
- `cost_tracking`: user_id + created_at, project_id
- `audit_logs`: user_id + created_at, action + created_at

### Performance Tips
1. Use `joinedload()` for eager loading relationships
2. Add `.options(load_only())` to select specific columns
3. Use pagination for large result sets
4. Monitor slow queries with `echo=True` in development

## Security Considerations

1. **Password Hashing**: Uses bcrypt with 12 rounds
2. **UUID Primary Keys**: Prevents enumeration attacks
3. **Soft Deletes**: Projects marked as 'deleted' not removed
4. **Audit Trail**: All actions logged for compliance
5. **Row-Level Security**: Enforce at application layer

## Backup and Maintenance

### Regular Maintenance
```sql
-- Vacuum and analyze tables
VACUUM ANALYZE users, projects, tasks;

-- Update statistics
ANALYZE;

-- Check table sizes
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### Backup Strategy
```bash
# Full backup
pg_dump -h localhost -U postgres -d ai_dev_platform > backup.sql

# Backup specific tables
pg_dump -h localhost -U postgres -d ai_dev_platform \
    -t users -t projects -t tasks > core_tables.sql
```

## Common Queries

### Get User's Monthly Usage
```python
from sqlalchemy import func, extract

current_month = datetime.utcnow().month
usage = db.query(
    func.sum(CostTracking.total_tokens),
    func.sum(CostTracking.total_cost)
).filter(
    CostTracking.user_id == user_id,
    extract('month', CostTracking.created_at) == current_month
).first()
```

### Find Idle Containers
```python
from datetime import datetime, timedelta

idle_time = datetime.utcnow() - timedelta(minutes=30)
idle_containers = db.query(Container).filter(
    Container.status == 'running',
    Container.last_active_at < idle_time
).all()
```

### Agent Performance Stats
```python
task_stats = db.query(
    Task.primary_agent,
    func.count(Task.id).label('total'),
    func.avg(Task.execution_time_seconds).label('avg_time')
).group_by(Task.primary_agent).all()
```

## Migration Best Practices

1. **Always test migrations** on a copy of production data
2. **Include down migrations** for rollback capability
3. **Keep migrations small** and focused
4. **Use batch operations** for large data updates
5. **Add indexes in separate migrations** from table creation

## Troubleshooting

### Common Issues

1. **Migration Conflicts**
   ```bash
   # Resolve by checking current version
   alembic current
   alembic history
   ```

2. **Connection Pool Exhaustion**
   - Switch to NullPool for async applications
   - Monitor active connections

3. **Slow Queries**
   - Check for missing indexes
   - Use EXPLAIN ANALYZE
   - Consider query optimization

This schema provides a robust foundation for the AI Development Platform with proper relationships, indexing, and security considerations.